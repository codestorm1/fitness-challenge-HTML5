/*
 StackMob JS SDK Version 0.8.0 
 Copyright 2012 StackMob Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */

(function(){window.StackMob=this.StackMob={DEFAULT_API_VERSION:0,DEFAULT_LOGIN_SCHEMA:"user",DEFAULT_LOGIN_FIELD:"username",DEFAULT_PASSWORD_FIELD:"password",EARTH_RADIANS_MI:3956.6,EARTH_RADIANS_KM:6367.5,FORCE_CREATE_REQUEST:"stackmob_force_create_request",ARRAY_FIELDNAME:"stackmob_array_fieldname",ARRAY_VALUES:"stackmob_array_values",CASCADE_DELETE:"stackmob_cascade_delete",HARD_DELETE:!0,SOFT_DELETE:!1,API_SERVER:"api.stackmob.com",RETRY_WAIT:1e4,RETRY_ATTEMPTS:3,REFRESH_TOKEN_KEY:"oauth2.refreshToken",POST:"POST",PUT:"PUT",DELETE:"DELETE",CONTENT_TYPE_JSON:"application/json",apiVersion:0,sdkVersion:"0.8.0",publicKey:null,Storage:{STORAGE_PREFIX:"stackmob.",persist:function(e,t){localStorage&&localStorage.setItem(this.STORAGE_PREFIX+e,t)},retrieve:function(e){return localStorage?localStorage.getItem(this.STORAGE_PREFIX+e):null},remove:function(e){localStorage&&localStorage.removeItem(this.STORAGE_PREFIX+e)}},_generateCallbacks:function(e,t){return e.success=function(e){t.isValidResult(e)?"function"==typeof t.yes&&t.yes(e):"function"==typeof t.no&&t.no(e)},!e.error&&"function"==typeof t.error&&(e.error=t.error),e},_containsCallbacks:function(e,t){return"object"==typeof e&&_.some(t,function(t){return"function"==typeof e[t]})},getLoggedInUser:function(e){var t=!this.isOAuth2Mode()&&this.Storage.retrieve(this.loggedInUserKey)||this.Storage.retrieve("oauth2.user");if(!e||!e.success)return this.isLoggedIn(e)&&t?t:null;this.hasValidOAuth(e)},isLoggedIn:function(e){if(!this._containsCallbacks(e,["yes","no"]))return!this.isLoggedOut()||this.hasValidOAuth(e);e=this._generateCallbacks(e,{isValidResult:function(e){return"undefined"!=typeof e},yes:e.yes,no:e.no,error:e.no}),this.hasValidOAuth(e)},isUserLoggedIn:function(e,t){if(!this._containsCallbacks(t,["yes","no"]))return e==this.getLoggedInUser(t);t=this._generateCallbacks(t,{isValidResult:function(t){return t==e},yes:t.yes,no:t.no,error:t.no}),this.hasValidOAuth(t)},isLoggedOut:function(e){if(!this._containsCallbacks(e,["yes","no"]))return!this.hasValidOAuth(e);e=this._generateCallbacks(e,{isValidResult:function(e){return"undefined"==typeof e},yes:e.yes,no:e.no,error:e.yes}),this.hasValidOAuth(e)},getScheme:function(){return!0===this.secure?"https":"http"},getBaseURL:function(){return StackMob.useRelativePathForAjax?StackMob.apiURL||window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/":StackMob.apiURL||this.getScheme()+"://"+StackMob.API_SERVER+"/"},throwError:function(e){throw Error(e)},urlError:function(){this.throwError('A "url" property or function must be specified')},requirePublicKey:function(){StackMob.publicKey||this.throwError("Error: This requires that you initialize StackMob with a public key.")},isOAuth2Mode:function(){return!isNaN(StackMob.publicKey&&!StackMob.privateKey)},prepareCredsForSaving:function(e,t,n,r,i){return r=(new Date).getTime()+1e3*r,e={"oauth2.accessToken":e,"oauth2.macKey":n,"oauth2.expires":r,"oauth2.user":i},e[StackMob.REFRESH_TOKEN_KEY]=t,e},saveOAuthCredentials:function(e){var t=e["oauth2.accessToken"],n=e[StackMob.REFRESH_TOKEN_KEY];this.Storage.retrieve("oauth2.accessToken")!=t&&this.Storage.persist("oauth2.expires",e["oauth2.expires"]),this.Storage.persist("oauth2.accessToken",t),this.Storage.persist(StackMob.REFRESH_TOKEN_KEY,n),this.Storage.persist("oauth2.macKey",e["oauth2.macKey"]),this.Storage.persist("oauth2.user",e["oauth2.user"])},hasValidOAuth:function(e){if(!this.isOAuth2Mode())return e&&e.error&&e.error(),!1;var t=this.getOAuthCredentials();if(!_.all([t["oauth2.accessToken"],t["oauth2.macKey"],t["oauth2.expires"]||0],_.identity))return e&&e.success&&e.success(void 0),!1;if(!StackMob.hasExpiredOAuth())return e&&e.success&&e.success(this.Storage.retrieve("oauth2.user")),this.Storage.retrieve("oauth2.user");if(!e||!e.success)return!1;var n=e.success;e.success=function(e){n(e[StackMob.loginField])},StackMob.refreshSession.call(StackMob,e)},shouldSendRefreshToken:function(){return this.hasExpiredOAuth()&&this.hasRefreshToken()&&this.shouldKeepLoggedIn()},keepLoggedIn:function(e){StackMob.Storage.persist("oauth2.shouldKeepLoggedIn",!0===e)},shouldKeepLoggedIn:function(){return"true"===StackMob.Storage.retrieve("oauth2.shouldKeepLoggedIn")},hasRefreshToken:function(){var e=this.getOAuthCredentials();return e&&"undefined"!=typeof e[StackMob.REFRESH_TOKEN_KEY]&&null!=e[StackMob.REFRESH_TOKEN_KEY]},getRefreshToken:function(){return this.getOAuthCredentials()[StackMob.REFRESH_TOKEN_KEY]},hasExpiredOAuth:function(){return this.isOAuth2Mode()&&null==this.getOAuthExpireTime()||this.getOAuthExpireTime()<=(new Date).getTime()},getOAuthCredentials:function(){var e=StackMob.Storage.retrieve("oauth2.accessToken"),t=StackMob.Storage.retrieve("oauth2.macKey"),n=StackMob.Storage.retrieve("oauth2.expires"),r=StackMob.Storage.retrieve(StackMob.REFRESH_TOKEN_KEY),e={"oauth2.accessToken":e,"oauth2.macKey":t,"oauth2.expires":n};return e[StackMob.REFRESH_TOKEN_KEY]=r,e},getOAuthExpireTime:function(){var e=this.Storage.retrieve("oauth2.expires");return e?parseInt(e):null},METHOD_MAP:{create:"POST",read:"GET",update:"PUT","delete":"DELETE",post:"POST",get:"GET",put:"PUT",addRelationship:"POST",appendAndSave:"PUT",deleteAndSave:"DELETE",login:"GET",accessToken:"POST",refreshToken:"POST",logout:"GET",forgotPassword:"POST",loginWithTempAndSetNewPassword:"GET",resetPassword:"POST",facebookAccessToken:"POST",createUserWithFacebook:"POST",linkUserWithFacebook:"POST"},getProperty:function(e,t){return!e||!e[t]?null:_.isFunction(e[t])?e[t]():e[t]},init:function(e){e=e||{},this.initStart(e),this.userSchema=e.userSchema||this.DEFAULT_LOGIN_SCHEMA,this.loginField=e.loginField||this.DEFAULT_LOGIN_FIELD,this.passwordField=e.passwordField||this.DEFAULT_PASSWORD_FIELD,this.newPasswordField=e.newPasswordField||"new_password",this.apiVersion=e.apiVersion||this.DEFAULT_API_VERSION,this.appName=this.getProperty(e,"appName")||this.throwError("An appName must be specified"),this.clientSubdomain=this.getProperty(e,"clientSubdomain"),this.publicKey=e.publicKey,this.apiURL=e.apiURL;var t=0<window.location.hostname.indexOf(".stackmobapp.com");return this.useRelativePathForAjax=e.useRelativePathForAjax||t,this.oauth2targetdomain=e.oauth2targetdomain||this.oauth2targetdomain||"www.stackmob.com",this.secure=!0===e.secure,this.fullURL=!0===e.fullURL||"undefined"!=typeof PhoneGap||this.fullURL,this.ajax=e.ajax||this.ajax,this.urlRoot=e.urlRoot||this.getBaseURL(),this.initEnd(e),this},initStart:function(){},initEnd:function(){}}}).call(this),function(){function e(e,t){var n=StackMob.getBaseURL(),r=t.url.replace(RegExp(n,"g"),"/"),i=n.replace(RegExp("^http://|^https://","g"),"").replace(/\//,""),s=StackMob.Storage.retrieve("oauth2.accessToken"),o=StackMob.Storage.retrieve("oauth2.macKey");StackMob.Storage.retrieve("oauth2.expires");if(StackMob.isOAuth2Mode()&&s&&o){var u=t.type,a=i.split(":"),i=1<a.length?a[0]:i,f=1<a.length?a[1]:"https"==n.substring(0,5)?443:80,n=Math.round((new Date).getTime()/1e3),a="n"+Math.round(1e4*Math.random()),r=CryptoJS.HmacSHA1(n+"\n"+a+"\n"+u+"\n"+r+"\n"+i+"\n"+f+"\n\n",o).toString(CryptoJS.enc.Base64);return'MAC id="'+s+'",ts="'+n+'",nonce="'+a+'",mac="'+r+'"'}}var t=this;_.extend(StackMob,{isSencha:function(){return t.Ext},isZepto:function(){return t.Zepto},initEnd:function(){StackMob.Model=Backbone.Model.extend({urlRoot:StackMob.urlRoot,url:function(){var e=StackMob.urlRoot||StackMob.urlError();return e+=this.schemaName},getPrimaryKeyField:function(){return this.schemaName+"_id"},constructor:function(){this.setIDAttribute(),Backbone.Model.prototype.constructor.apply(this,arguments)},initialize:function(){StackMob.getProperty(this,"schemaName")||StackMob.throwError("A schemaName must be defined"),this.setIDAttribute()},setIDAttribute:function(){this.idAttribute=this.getPrimaryKeyField()},parse:function(e){return!e||e&&(!e.text||""==e.text)?e:JSON.parse(e.text)},sync:function(e,t,n){StackMob.sync.call(this,e,this,n)},create:function(e){var t={};t[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(t,e),this.save(null,t)},query:function(e,t){t=t||{},_.extend(t,{query:e}),this.fetch(t)},save:function(e,t){var n=e?e.success:{},r=e?e.error:{};"undefined"==typeof t&&(_.isFunction(n)||_.isFunction(r))?Backbone.Model.prototype.save.call(this,null,e):Backbone.Model.prototype.save.call(this,e,t)},fetchExpanded:function(e,t){(0>e||3<e)&&StackMob.throwError("Depth must be between 0 and 3 inclusive.");var n={};_.extend(n,t),n.data=n.data||{},n.data._expand=e,this.fetch(n)},getAsModel:function(e,t){var n=this.get(e);return n?_.isArray(n)?_.map(n,function(e){return new t(e)}):new t(n):{}},appendAndCreate:function(e,t,n){this.addRelationship(e,t,n)},addRelationship:function(e,t,n){n=n||{},n[StackMob.ARRAY_FIELDNAME]=e,n[StackMob.ARRAY_VALUES]=t,StackMob.sync.call(this,"addRelationship",this,n)},appendAndSave:function(e,t,n){n=n||{},n[StackMob.ARRAY_FIELDNAME]=e,n[StackMob.ARRAY_VALUES]=t,StackMob.sync.call(this,"appendAndSave",this,n)},deleteAndSave:function(e,t,n,r){r=r||{},r[StackMob.ARRAY_FIELDNAME]=e,r[StackMob.ARRAY_VALUES]=t,r[StackMob.CASCADE_DELETE]=n;var i=this;r.stackmob_ondeleteAndSave=function(){var n=i.get(e);i.set(e,_.difference(n,t))},StackMob.sync.call(this,"deleteAndSave",this,r)},setBinaryFile:function(e,t,n,r){this.set(e,"Content-Type: "+n+"\nContent-Disposition: attachment; filename="+t+"\nContent-Transfer-Encoding: base64\n\n"+r)},incrementOnSave:function(e,t){this.attributes[this.idAttribute]?(this.attributes[e]&&delete this.attributes[e],this.set(e+"[inc]",t)):StackMob.throwError("Please specify an id for the row you wish to update. When creating a new instance of your object, you need to pass in JSON that includes the id field and value (e.g. var user = new StackMob.User({ username: 'chucknorris' });)  Or, for custom objects: var todoInstance = new Todo({todo_id : '1234'})")},decrementOnSave:function(e,t){this.incrementOnSave(e,-1*t)}}),StackMob.Collection=Backbone.Collection.extend({initialize:function(){this.model||StackMob.throwError("Please specify a StackMob.Model for this collection. e.g., var Items = StackMob.Collection.extend({ model: Item });"),this.schemaName=(new this.model).schemaName},url:function(){var e=StackMob.urlRoot||StackMob.urlError();return e+=this.schemaName},parse:function(e){return!e||e&&(!e.text||""==e.text)?e:JSON.parse(e.text)},sync:function(e,t,n){StackMob.sync.call(this,e,this,n)},query:function(e,t){t=t||{},_.extend(t,{query:e}),this.fetch(t)},create:function(e,t){var n={};n[StackMob.FORCE_CREATE_REQUEST]=!0,_.extend(n,t),Backbone.Collection.prototype.create.call(this,e,n)},count:function(e,t){e=e||new StackMob.Collection.Query,t=t||{},t.stackmob_count=!0;var n=t.success;return t.success=function(e){if(e&&e.getAllResponseHeaders){var t=e.getResponseHeader("Content-Range"),r=0;t&&(r=t.substring(t.indexOf("/")+1,t.length));if(0===r)try{r=JSON.parse(e.responseText).length}catch(i){}n&&n(r)}else n(e)},e.setRange&&(t.query=e.setRange(0,0)),(this.sync||Backbone.sync).call(this,"query",this,t)}}),StackMob.User=StackMob.Model.extend({idAttribute:StackMob.loginField,schemaName:StackMob.userSchema,getPrimaryKeyField:function(){return StackMob.loginField},isLoggedIn:function(e){if(!StackMob._containsCallbacks(e,["yes","no"]))return StackMob.isUserLoggedIn(this.get(StackMob.loginField),e);e=StackMob._generateCallbacks(e,{isValidResult:function(e){return"undefined"!=typeof e},yes:e.yes,no:e.no,error:e.no}),StackMob.hasValidOAuth(e)},login:function(e,t){t=t||{},StackMob.keepLoggedIn("undefined"==typeof e?!1:e),t.data=t.data||{},t.data[StackMob.loginField]=this.get(StackMob.loginField),t.data[StackMob.passwordField]=this.get(StackMob.passwordField),StackMob.isOAuth2Mode()&&(t.data.token_type="mac"),t.stackmob_onaccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,StackMob.isOAuth2Mode()?"accessToken":"login",this,t)},logout:function(e){e=e||{},e.data=e.data||{},e.stackmob_onlogout=function(){StackMob.Storage.remove(StackMob.loggedInUserKey),StackMob.Storage.remove("oauth2.accessToken"),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY),StackMob.Storage.remove("oauth2.macKey"),StackMob.Storage.remove("oauth2.expires"),StackMob.Storage.remove("oauth2.user")},(this.sync||Backbone.sync).call(this,"logout",this,e)},loginWithFacebookToken:function(e,t,n){n=n||{},n.data=n.data||{},_.extend(n.data,{fb_at:e,token_type:"mac"}),n.stackmob_onfacebookAccessToken=StackMob.processLogin,(this.sync||Backbone.sync).call(this,"facebookAccessToken",this,n)},createUserWithFacebook:function(e,t){t=t||{},t.data=t.data||{},_.extend(t.data,{fb_at:e,token_type:"mac"}),t.data[StackMob.loginField]=t[StackMob.loginField]||this.get(StackMob.loginField),(this.sync||Backbone.sync).call(this,"createUserWithFacebook",this,t)},linkUserWithFacebook:function(e,t){t=t||{},t.data=t.data||{},_.extend(t.data,{fb_at:e,token_type:"mac"}),(this.sync||Backbone.sync).call(this,"linkUserWithFacebook",this,t)},loginWithTempAndSetNewPassword:function(e,t,n,r){r=r||{},r.data=r.data||{};var i={};i[StackMob.passwordField]=e,this.set(i),r.data[StackMob.newPasswordField]=t,this.login(n,r)},forgotPassword:function(e){e=e||{},e.data=e.data||{},e.data[StackMob.loginField]=this.get(StackMob.loginField),(this.sync||Backbone.sync).call(this,"forgotPassword",this,e)},resetPassword:function(e,t,n){n=n||{},n.data=n.data||{},n.data.old={password:e},n.data["new"]={password:t},(this.sync||Backbone.sync).call(this,"resetPassword",this,n)}}),StackMob.Users=StackMob.Collection.extend({model:StackMob.User}),StackMob.GeoPoint=function(e,t){_.isNumber(e)?((-90>e||90<e)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(-180>t||180<t)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=e,this.lon=t):((-90>e.lat||90<e.lat)&&StackMob.throwError("Latitude value must be between -90 and 90 inclusive."),(-180>e.lon||180<e.lon)&&StackMob.throwError("Longitude value must be between -180 and 180 inclusive."),this.lat=e.lat,this.lon=e.lon)},StackMob.GeoPoint.prototype.toJSON=function(){return{lat:this.lat,lon:this.lon}},StackMob.Model.Query=function(){this.selectFields=[],this.params={}},_.extend(StackMob.Model.Query.prototype,{select:function(e){return this.selectFields.push(e),this},setExpand:function(e){return this.params._expand=e,this}}),StackMob.Collection.Query=function(){this.params={},this.selectFields=[],this.orderBy=[],this.range=null},StackMob.Collection.Query.prototype=new StackMob.Model.Query,StackMob.Collection.Query.prototype.constructor=StackMob.Collection.Query,_.extend(StackMob.Collection.Query.prototype,{addParam:function(e,t){return this.params[e]=t,this},equals:function(e,t){return this.params[e]=t,this},lt:function(e,t){return this.params[e+"[lt]"]=t,this},lte:function(e,t){return this.params[e+"[lte]"]=t,this},gt:function(e,t){return this.params[e+"[gt]"]=t,this},gte:function(e,t){return this.params[e+"[gte]"]=t,this},notEquals:function(e,t){return this.params[e+"[ne]"]=t,this},isNull:function(e){return this.params[e+"[null]"]=!0,this},isNotNull:function(e){return this.params[e+"[null]"]=!1,this},mustBeOneOf:function(e,t){var n="";if(_.isArray(t))for(var r=t.length,i=0;i<r;i++)n+=t[i],i+1<r&&(n+=",");else n=t;return this.params[e+"[in]"]=n,this},orderAsc:function(e){return this.orderBy.push(e+":asc"),this},orderDesc:function(e){return this.orderBy.push(e+":desc"),this},setRange:function(e,t){return this.range={start:e,end:t},this},mustBeNear:function(e,t,n){return this.params[e+"[near]"]=t.lat+","+t.lon+","+n,this},mustBeNearMi:function(e,t,n){return this.mustBeNear(e,t,n/StackMob.EARTH_RADIANS_MI),this},mustBeNearKm:function(e,t,n){return this.mustBeNear(e,t,n/StackMob.EARTH_RADIANS_KM),this},isWithin:function(e,t,n){return this.params[e+"[within]"]=t.lat+","+t.lon+","+n,this},isWithinMi:function(e,t,n){return this.isWithin(e,t,n/StackMob.EARTH_RADIANS_MI),this},isWithinKm:function(e,t,n){return this.isWithin(e,t,n/StackMob.EARTH_RADIANS_KM),this},isWithinBox:function(e,t,n){return this.params[e+"[within]"]=t.lat+","+t.lon+","+n.lat+","+n.lon,this}})},cc:function(e,t,n,r){this.customcode(e,t,n,r)},customcode:function(e,t,n,r){_.isObject(n)?(r=n||{},n=(n=r.httpVerb)&&!_.isUndefined(StackMob.METHOD_MAP[n.toLowerCase()])?n:"GET",r.httpVerb=n):(r=r||{},_.isString(n)&&n&&!_.isUndefined(StackMob.METHOD_MAP[n.toLowerCase()])&&(r.httpVerb=n.toUpperCase())),r.data=r.data||{},"GET"!==n&&(r.contentType=r.contentType||StackMob.CONTENT_TYPE_JSON),_.extend(r.data,t),r.url=this.getBaseURL(),this.sync.call(StackMob,e,null,r)},processLogin:function(e){if(StackMob.isOAuth2Mode()){var t=e.access_token,n=e.refresh_token,r=e.mac_key,i=e.expires_in,s=null;try{var s=e.stackmob.user[StackMob.loginField],o=StackMob.prepareCredsForSaving(t,n,r,i,s);StackMob.saveOAuthCredentials(o),StackMob.Storage.persist(StackMob.loggedInUserKey,s)}catch(u){console&&console.error("Problem saving OAuth 2.0 credentials and user")}}},getCallId:function(e,t){var n={method:e,model:t||{},time:(new Date).getTime()};return JSON.stringify(n)},sync:function(t,n,r){r=r||{};if(!StackMob.isAccessTokenMethod(t)&&StackMob.shouldSendRefreshToken()&&!0!==r.stackmob_attempted_refresh){var i=t,s=r;s.stackmob_attempted_refresh=!0;var o=this;return StackMob.refreshSession.call(StackMob,{oncomplete:function(){StackMob.sync.call(o,i,n,s)}}),!1}var u=!0===r[StackMob.FORCE_CREATE_REQUEST];u&&(t="create");var a=_.extend({type:r.httpVerb||StackMob.METHOD_MAP[t]||"GET",dataType:"json"},r);a.data=a.data||{},!a.url&&n&&(a.url=StackMob.getProperty(n,"url"));var f="cc"!=t,l=n&&n.isNew&&!n.isNew(),u=!u,h="addRelationship"==t||"appendAndSave"==t||"deleteAndSave"==t;if(_.include("create update delete read query deleteAndSave appendAndSave addRelationship".split(" "),t)){if(h||f&&l&&u)a.url+=("/"==a.url.charAt(a.url.length-1)?"":"/")+encodeURIComponent(n.get(n.getPrimaryKeyField())),h&&(a.url+="/"+r[StackMob.ARRAY_FIELDNAME]),"deleteAndSave"==t&&(f="",f=_.isArray(r[StackMob.ARRAY_VALUES])?_.map(r[StackMob.ARRAY_VALUES],function(e){return encodeURIComponent(e)}).join(","):encodeURIComponent(r[StackMob.ARRAY_VALUES]),a.url+="/"+f)}else a.url+=("/"==a.url.charAt(a.url.length-1)?"":"/")+t;f=r,a.headers=a.headers||{},a.headers=_.extend({Accept:"application/vnd.stackmob+json; version="+StackMob.apiVersion},a.headers),_.extend(a.headers,{"X-StackMob-User-Agent":"StackMob (JS; "+StackMob.sdkVersion+")"}),StackMob.publicKey&&!StackMob.privateKey?(a.headers["X-StackMob-API-Key"]=StackMob.publicKey,a.headers["X-StackMob-Proxy-Plain"]="stackmob-api",a.headers["X-StackMob-API-Key-"+StackMob.publicKey]=""):a.headers["X-StackMob-Proxy"]="stackmob-api",StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(t)?a.contentType="application/x-www-form-urlencoded":_.include(["PUT","POST"],StackMob.METHOD_MAP[t])&&(a.contentType=a.contentType||StackMob.CONTENT_TYPE_JSON),isNaN(f[StackMob.CASCADE_DELETE])||(a.headers["X-StackMob-CascadeDelete"]=1==f[StackMob.CASCADE_DELETE]);if(f.query&&(f=a.query||throwError("No StackMobQuery object provided to the query call."),f.selectFields&&0<f.selectFields.length&&(a.headers["X-StackMob-Select"]=f.selectFields.join()),f.range&&(a.headers.Range="objects="+f.range.start+"-"+f.range.end),_.extend(a.data,f.params),f.orderBy&&0<f.orderBy.length)){f=f.orderBy,l="",u=f.length;for(h=0;h<u;h++)l+=f[h],h+1<u&&(l+=",");a.headers["X-StackMob-OrderBy"]=l}f=t,l=function(e){return _.map(_.keys(e),function(t){return t+"="+encodeURIComponent(e[t])}).join("&")},r=r||{};if(StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(f))a.data=l(a.data);else if("POST"==a.type||"PUT"==a.type)if("resetPassword"==f||"forgotPassword"==f)a.data=JSON.stringify(a.data);else if("addRelationship"==f||"appendAndSave"==f)r&&r[StackMob.ARRAY_VALUES]&&(a.data=JSON.stringify(r[StackMob.ARRAY_VALUES]));else if(n){var p=n.toJSON();_.each(r.remote_ignore||[],function(e){delete p[e]}),delete p.lastmoddate,delete p.createddate,"update"==f&&delete p[StackMob.passwordField],StackMob.isOAuth2Mode()&&delete p.sm_owner,a.data=JSON.stringify(_.extend(p,a.data))}else a.data=JSON.stringify(a.data);else"GET"==a.type&&!_.isEmpty(a.data)&&(a.url+="?",r=l(a.data),a.url+=r),delete a.data;r=a||{},r.processData=!1,r.accepts=r.headers.Accept,StackMob.isAccessTokenMethod(t)||(r=t,StackMob.isAccessTokenMethod(r)||(r=e(r,a))&&(a.headers.Authorization=r)),StackMob.makeAPICall(n,a,t)},refreshSession:function(e){var t={};_.extend(t,e);if(StackMob.hasRefreshToken()){t.url="/"+StackMob.userSchema,t.contentType="application/x-www-form-urlencoded",t.data={refresh_token:StackMob.getOAuthCredentials()[StackMob.REFRESH_TOKEN_KEY],grant_type:"refresh_token",token_type:"mac",mac_algorithm:"hmac-sha1"};var n=e.oncomplete;n&&(t.oncomplete=function(){n()}),e&&e.success&&(t.success=e.success),t.stackmob_onrefreshToken=StackMob.processLogin,t.error=function(){e&&e.error&&e.error(),StackMob.Storage.remove(StackMob.REFRESH_TOKEN_KEY)},(this.sync||Backbone.sync).call(this,"refreshToken",this,t)}else e&&e.error&&e.error()},makeAPICall:function(e,t,n){return StackMob.ajax?StackMob.ajax(e,t,n):StackMob.isSencha()?StackMob.ajaxOptions.sencha(e,t,n):StackMob.isZepto()?StackMob.ajaxOptions.zepto(e,t,n):StackMob.ajaxOptions.jquery(e,t,n)},onsuccess:function(e,t,n,r,i){n&&(_.isFunction(n["stackmob_on"+t])&&n["stackmob_on"+t](r),_.isFunction(n.oncomplete)&&n.oncomplete(r)),i&&(r?(StackMob.isOAuth2Mode()&&StackMob.isAccessTokenMethod(t)&&r.stackmob&&(r=r.stackmob.user),i(r)):i())},onerror:function(t,n,r,i,s,o){var u=t.status,a;try{a=JSON.parse(n)}catch(f){a={error:"Invalid JSON returned."}}if(503==u){t=t.getResponseHeader("retry-after");try{t=1e3*parseInt(responseHeaderValue)}catch(l){t=StackMob.RETRY_WAIT}if("number"==typeof s.stackmob_retry){if(s.stackmob_retry-=1,0>=s.stackmob_retry)return}else s.stackmob_retry=StackMob.RETRY_ATTEMPTS;_.delay(function(){var t=e(i,s);s.headers.Authorization=t,r(s)},t)}else _.isFunction(s.oncomplete)&&s.oncomplete(a),o&&o(i,a)},isAccessTokenMethod:function(e){return _.include(["accessToken","facebookAccessToken","refreshToken"],e)}})}.call(this),function(){var e=this.jQuery||this.Ext||this.Zepto;_.extend(StackMob,{ajaxOptions:{sencha:function(t,n,r){var i={},s=n.success;n.success=function(e){var i=e&&e.responseText?JSON.parse(e.responseText):null;!0===n.stackmob_count&&(i=e),StackMob.onsuccess(t,r,n,i,s)};var o=n.error;return i.url=n.url,i.headers=n.headers,i.params=n.data,i.success=n.success,i.disableCaching=!1,i.method=n.type,n.error=function(n){StackMob.onerror(n,n.responseText||n.text,e.Ajax.request,t,i,o)},i.failure=n.error,e.Ajax.request(i)},zepto:function(t,n,r){var i=n.success,s=function(e,s){s=e?JSON.parse(e):null,StackMob.onsuccess(t,r,n,s,i)};n.success=s;var o=n.error,u=function(r){StackMob.onerror(r,r.responseText||r.text,e.ajax,t,n,o)};n.error=u;var a={};return a.url=n.url,a.headers=n.headers,a.contentType=n.headers.contentType,a.type=n.type,a.data=n.data,a.success=s,a.error=u,e.ajax(a)},jquery:function(t,n,r){n.beforeSend=function(e,t){e.setRequestHeader("Accept",t.accepts);if(!_.isEmpty(t.headers))for(key in t.headers)e.setRequestHeader(key,t.headers[key])};var i=n.error;n.error=function(r,s,o){0==r.status&&n.query&&"object"==typeof n.query.range?this.success(r,s,o):StackMob.onerror(r,r.responseText||r.text,e.ajax,t,n,i)};var s=n.success;return n.success=function(e,t,i){var o;!0===n.stackmob_count?o=i:e&&e.toJSON?o=e:e&&(e.responseText||e.text)?o=JSON.parse(e.responseText||e.text):e&&(o=e),StackMob.onsuccess(e,r,n,o,s)},e.ajax(n)}}})}.call(this);var CryptoJS=CryptoJS||function(e,t){var n={},r=n.lib={},i=function(){},s=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.$super.extend(this)}},o=r.WordArray=s.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,e=e.sigBytes;this.clamp();if(r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return o.create(n,t)}}),u=n.enc={},a=u.Hex={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-8*(r%4)&255;n.push((i>>>4).toString(16)),n.push((i&15).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-4*(r%8);return o.create(n,t/2)}},f=u.Latin1={stringify:function(e){for(var t=e.words,e=e.sigBytes,n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-8*(r%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(e.charCodeAt(r)&255)<<24-8*(r%4);return o.create(n,t)}},l=u.Utf8={stringify:function(e){try{return decodeURIComponent(escape(f.stringify(e)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(e){return f.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=o.create(),this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,s=this.blockSize,u=i/(4*s),u=t?e.ceil(u):e.max((u|0)-this._minBufferSize,0),t=u*s,i=e.min(4*t,i);if(t){for(var a=0;a<t;a+=s)this._doProcessBlock(r,a);a=r.splice(0,t),n.sigBytes-=i}return o.create(a,i)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({init:function(){this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize(),this._hash},clone:function(){var e=c.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:16,_createHelper:function(e){return function(t,n){return e.create(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return h.HMAC.create(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);(function(){var e=CryptoJS,t=e.lib,n=t.WordArray,t=t.Hasher,r=[],i=e.algo.SHA1=t.extend({_doReset:function(){this._hash=n.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=0;80>f;f++){if(16>f)r[f]=e[t+f]|0;else{var l=r[f-3]^r[f-8]^r[f-14]^r[f-16];r[f]=l<<1|l>>>31}l=(i<<5|i>>>27)+a+r[f],l=20>f?l+((s&o|~s&u)+1518500249):40>f?l+((s^o^u)+1859775393):60>f?l+((s&o|s&u|o&u)-1894007588):l+((s^o^u)-899497514),a=u,u=o,o=s<<30|s>>>2,s=i,i=l}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+o|0,n[3]=n[3]+u|0,n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[(r+64>>>9<<4)+15]=n,e.sigBytes=4*t.length,this._process()}});e.SHA1=t._createHelper(i),e.HmacSHA1=t._createHmacHelper(i)})(),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=e.create(),"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n));for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),u=s.words,a=o.words,l=0;l<r;l++)u[l]^=1549556828,a[l]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();for(var e=[],i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-8*(i%4)&255)<<16|(t[i+1>>>2]>>>24-8*((i+1)%4)&255)<<8|t[i+2>>>2]>>>24-8*((i+2)%4)&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var e=e.replace(/\s/g,""),n=e.length,r=this._map,i=r.charAt(64);i&&(i=e.indexOf(i),-1!=i&&(n=i));for(var i=[],s=0,o=0;o<n;o++)if(o%4){var u=r.indexOf(e.charAt(o-1))<<2*(o%4),a=r.indexOf(e.charAt(o))>>>6-2*(o%4);i[s>>>2]|=(u|a)<<24-8*(s%4),s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();